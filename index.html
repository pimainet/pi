<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ví Pi - Vũ trụ Rồng Vàng</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link href="./styles/tailwind.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
      html {
        scroll-behavior: smooth;
        overscroll-behavior: contain;
      }
      body {
        background: linear-gradient(135deg, #0a0a23 0%, #1a1a3d 100%);
        color: #e2e8f0;
        font-family: 'Quicksand', sans-serif;
        overflow-x: hidden;
        margin: 0;
        height: 100vh;
      }
      #header {
        position: fixed;
        top: 0;
        width: 100%;
        background: linear-gradient(90deg, #dc2626, #d4af37, #2dd4bf);
        padding: 1rem;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(212, 175, 55, 0.6);
      }
      #header .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0a0a23;
        text-shadow: 0 0 10px #d4af37;
      }
      #nav-menu {
        display: flex;
        justify-content: center;
        gap: 2rem;
      }
      #nav-menu button {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #d4af37;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        color: #e2e8f0;
        font-weight: 500;
      }
      #nav-menu button:hover {
        background: linear-gradient(45deg, #2dd4bf, #d4af37);
        color: #0a0a23;
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
      }
      #nav-menu button.active {
        background: #d4af37;
        color: #0a0a23;
      }
      #starfield {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
      #dashboard {
        margin-top: 80px;
        padding: 2rem;
        background: rgba(10, 10, 35, 0.9);
        border-radius: 16px;
        border: 2px solid #d4af37;
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        animation: fadeIn 1s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .avatar-3d {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        border: 3px solid #d4af37;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.7);
        transition: transform 0.5s ease;
      }
      .avatar-3d:hover {
        transform: rotateY(360deg);
      }
      .tab-content {
        display: none;
        padding: 1rem;
      }
      .tab-content.active {
        display: block;
      }
      .btn {
        background: linear-gradient(45deg, #dc2626, #d4af37);
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        color: #fff;
        transition: all 0.3s ease;
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }
      .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
      }
      .btn:active {
        transform: scale(0.95);
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal {
        background: rgba(15, 15, 45, 0.95);
        border: 3px solid #d4af37;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
      }
      .modal::-webkit-scrollbar {
        width: 8px;
      }
      .modal::-webkit-scrollbar-thumb {
        background: #d4af37;
        border-radius: 4px;
      }
      .dragon-3d {
        position: absolute;
        width: 150px;
        opacity: 0;
        animation: flyDragon 5s ease-in-out;
        pointer-events: none;
      }
      @keyframes flyDragon {
        0% { transform: translate(100%, 100%) rotate(0deg); opacity: 0; }
        25% { transform: translate(-50%, -50%) rotate(45deg); opacity: 1; }
        75% { transform: translate(-100%, -100%) rotate(90deg); opacity: 1; }
        100% { transform: translate(-200%, -200%) rotate(180deg); opacity: 0; }
      }
      .dragon-3d.show {
        opacity: 1;
      }
      .lotus-animation {
        position: absolute;
        width: 100px;
        opacity: 0;
        animation: bloom 3s ease-in-out forwards;
      }
      @keyframes bloom {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }
      .lotus-animation.show {
        opacity: 1;
      }
      #tradingview_chart {
        height: 300px;
        width: 100%;
      }
      .chat-box {
        border: 2px solid #d4af37;
        border-radius: 10px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        height: 200px;
        overflow-y: auto;
      }
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #d4af37;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1.5s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @media (max-width: 640px) {
        #header { padding: 0.5rem; }
        #nav-menu { flex-direction: column; gap: 0.5rem; }
        #dashboard { margin-top: 60px; padding: 1rem; }
        .avatar-3d { width: 80px; height: 80px; }
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="starfield"></div>
    <div id="header" class="flex justify-between items-center">
      <span class="logo">Pi Dragon Vault</span>
      <div id="nav-menu">
        <button class="active" onclick="showTab('wallet')">Ví Pi</button>
        <button onclick="showTab('explore')">Khám phá</button>
        <button onclick="showTab('price')">Giá Pi</button>
        <button onclick="showTab('support')">Hỗ trợ</button>
        <button onclick="openSettingsModal()">Cài đặt</button>
      </div>
    </div>
    <div id="dashboard" class="container mx-auto mt-20">
      <div id="loadingSpinner" class="spinner mx-auto"></div>
      <div class="flex items-center mb-4">
        <img
          id="avatar"
          src="https://source.unsplash.com/100x100/?vietnam,conical-hat"
          alt="Avatar VIP"
          class="avatar-3d mr-4"
          loading="lazy"
        />
        <div>
          <h2 id="userName" class="text-2xl font-bold">Nhà du hành</h2>
          <span id="userLevel" class="level-badge">Level 1: New Explorer</span>
          <div class="mt-2">
            <span class="balance-badge">Pi: <span id="piBalance">0</span></span>
            <span class="balance-badge">Pidoge: <span id="pidogeBalance">0</span></span>
            <span class="balance-badge">tlk: <span id="tlkBalance">0</span></span>
          </div>
        </div>
      </div>
      <div id="wallet" class="tab-content active">
        <p class="text-lg">Mã ví: <span id="walletAddress" class="break-words">Chưa nhập</span></p>
        <div class="flex space-x-2 mt-4">
          <button onclick="copyWalletAddress()" class="btn">Sao chép</button>
          <button onclick="checkBalance()" class="btn">Kiểm tra</button>
        </div>
        <div class="mt-4">
          <h3 class="text-xl font-semibold">Lịch sử giao dịch</h3>
          <ul id="transactionHistory" class="mt-2"></ul>
        </div>
      </div>
      <div id="explore" class="tab-content">
        <p class="text-lg">Trạng thái: <span id="checkInStatus">Chưa khám phá</span></p>
        <button id="checkInButton" onclick="checkIn()" class="btn mt-4">Khám phá</button>
        <button onclick="openHistoryModal()" class="btn mt-2">Xem nhật ký</button>
        <div id="leaderboard" class="mt-4">
          <h3 class="text-xl font-semibold">Bảng xếp hạng</h3>
          <ul id="leaderboardList"></ul>
        </div>
      </div>
      <div id="price" class="tab-content">
        <div id="tradingview_chart"></div>
        <div class="mt-4">
          <h3 class="text-xl font-semibold">Tin tức Crypto</h3>
          <p id="cryptoNews">Đang tải...</p>
        </div>
      </div>
      <div id="support" class="tab-content">
        <div class="flex space-x-2 mb-4">
          <button onclick="openSafetyModal()" class="btn">Kiểm tra an toàn</button>
          <button onclick="openChatModal()" class="btn">Chat Grok</button>
        </div>
        <p class="text-lg">Hotline: <a href="tel:+84987654321" class="text-yellow-400">+84 987 654 321</a></p>
        <div class="video-container mt-4">
          <iframe
            src="https://www.youtube.com/embed/dQw4w9WgXcQ"
            title="Hướng dẫn"
            frameborder="0"
            allow="accelerometer; clipboard-write; encrypted-media"
            allowfullscreen
          ></iframe>
        </div>
      </div>
      <svg id="dragon" class="dragon-3d" viewBox="0 0 200 200">
        <path fill="#d4af37" d="M100 160C40 160 20 120 20 100C20 80 40 40 100 40C160 40 180 80 180 100C180 120 160 160 100 160Z" />
        <path fill="#dc2626" d="M60 100C60 90 80 80 100 80C120 80 140 90 140 100C140 110 120 120 100 120C80 120 60 110 60 100Z" />
      </svg>
      <img id="lotus" class="lotus-animation" src="https://source.unsplash.com/100x100/?lotus" alt="Lotus" />
    </div>
    <div id="historyModal" class="modal-overlay">
      <div class="modal">
        <span class="modal-close" onclick="closeModal('historyModal')">×</span>
        <h2 class="text-2xl font-bold">Nhật ký du hành</h2>
        <ul id="checkInHistory" class="mt-4"></ul>
        <button onclick="closeModal('historyModal')" class="btn mt-4">Đóng</button>
      </div>
    </div>
    <div id="safetyModal" class="modal-overlay">
      <div class="modal">
        <span class="modal-close" onclick="closeModal('safetyModal')">×</span>
        <h2 class="text-2xl font-bold">Kiểm tra an toàn</h2>
        <select id="checkType" class="w-full p-2 mt-2 bg-gray-800 text-white rounded">
          <option value="website">Trang web</option>
          <option value="app">Ứng dụng</option>
        </select>
        <input id="safetyUrl" type="text" placeholder="Nhập URL" class="w-full p-2 mt-2 bg-gray-800 text-white rounded" />
        <button onclick="checkSafety()" class="btn mt-2">Kiểm tra</button>
        <div id="safetyResult" class="mt-4 hidden">
          <p>Kết quả: <span id="safetyStatus"></span></p>
          <p>Điểm tin cậy: <span id="safetyScore"></span>/100</p>
          <p>Cảnh báo: <span id="safetyWarnings"></span></p>
        </div>
      </div>
    </div>
    <div id="chatModal" class="modal-overlay">
      <div class="modal">
        <span class="modal-close" onclick="closeModal('chatModal')">×</span>
        <h2 class="text-2xl font-bold">Chat với Grok</h2>
        <div id="chatBox" class="chat-box mt-2"></div>
        <input id="chatInput" type="text" placeholder="Nhập tin nhắn..." class="w-full p-2 mt-2 bg-gray-800 text-white rounded" />
        <button onclick="sendMessage()" class="btn mt-2">Gửi</button>
      </div>
    </div>
    <div id="settingsModal" class="modal-overlay">
      <div class="modal">
        <span class="modal-close" onclick="closeModal('settingsModal')">×</span>
        <h2 class="text-2xl font-bold">Cài đặt</h2>
        <p>Chưa có tùy chọn cài đặt</p>
        <button onclick="closeModal('settingsModal')" class="btn mt-4">Đóng</button>
      </div>
    </div>
    <audio id="checkInSound" src="https://assets.mixkit.co/sfx/preview/mixkit-scifi-click-902.mp3"></audio>
    <script>
      const API_BASE_URL = 'https://pi-wallet.onrender.com';
      const LEVEL_AVATARS = { 1: 'https://source.unsplash.com/100x100/?vietnam,conical-hat', 2: 'https://source.unsplash.com/100x100/?vietnam,dragon', 3: 'https://source.unsplash.com/100x100/?lotus' };
      const LEVEL_NAMES = { 1: 'Level 1: New Explorer', 2: 'Level 2: Dragon Seeker', 3: 'Level 3: Lotus Master' };

      function initStarfield() {
        if (typeof particlesJS === 'undefined') {
          document.getElementById('starfield').style.background = '#0a0a23';
          return;
        }
        particlesJS('starfield', {
          particles: { number: { value: 100 }, color: { value: '#fff' }, size: { value: 3 }, move: { speed: 1 } },
          interactivity: { events: { resize: true } },
        });
      }

      function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.background = '#d4af37';
        toast.style.padding = '1rem';
        toast.style.borderRadius = '8px';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('#nav-menu button').forEach(b => b.classList.remove('active'));
        document.querySelector(`#nav-menu button[onclick="showTab('${tabId}')"]`).classList.add('active');
      }

      function openModal(modalId) { document.getElementById(modalId).classList.add('show'); }
      function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

      async function loadUserData() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const tagId = new URLSearchParams(window.location.search).get('tag_id');
        loadingSpinner.style.display = 'block';
        if (!tagId) {
          document.getElementById('userName').textContent = 'Khách viếng thăm';
          document.getElementById('walletAddress').textContent = 'Chưa đăng nhập';
          loadingSpinner.style.display = 'none';
          return;
        }
        try {
          const response = await fetch(`${API_BASE_URL}/api/user/${tagId}`);
          const user = await response.json();
          if (response.ok) {
            document.getElementById('userName').textContent = user.name || 'Nhà du hành';
            document.getElementById('walletAddress').textContent = user.wallet_address || 'Chưa có';
            document.getElementById('piBalance').textContent = user.pi_balance || 0;
            document.getElementById('pidogeBalance').textContent = user.pidoge_balance || 0;
            document.getElementById('tlkBalance').textContent = user.tlk_balance || 0;
            document.getElementById('avatar').src = LEVEL_AVATARS[1];
            document.getElementById('userLevel').textContent = LEVEL_NAMES[1];
          } else throw new Error(user.error);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải dữ liệu: ' + err.message);
        } finally {
          loadingSpinner.style.display = 'none';
        }
      }

      async function checkIn() {
        const tagId = new URLSearchParams(window.location.search).get('tag_id');
        if (!tagId) return showToast('Tag ID không hợp lệ');
        const dragon = document.getElementById('dragon');
        dragon.classList.add('show');
        setTimeout(() => dragon.classList.remove('show'), 5000);
        const lotus = document.getElementById('lotus');
        lotus.classList.add('show');
        setTimeout(() => lotus.classList.remove('show'), 3000);
        showToast('Khám phá thành công!');
      }

      function copyWalletAddress() {
        const walletAddress = document.getElementById('walletAddress').textContent;
        if (walletAddress === 'Chưa có') return showToast('Không có mã ví');
        navigator.clipboard.writeText(walletAddress).then(() => showToast('Đã sao chép'));
      }

      function checkBalance() {
        const walletAddress = document.getElementById('walletAddress').textContent;
        if (walletAddress === 'Chưa có') return showToast('Không có mã ví');
        window.open(`https://blockexplorer.minepi.com/mainnet/accounts/${walletAddress}`);
      }

      function checkSafety() {
        const safetyResult = document.getElementById('safetyResult');
        safetyResult.classList.remove('hidden');
        document.getElementById('safetyStatus').textContent = 'An toàn';
        document.getElementById('safetyScore').textContent = '90';
        document.getElementById('safetyWarnings').textContent = 'Không có';
        showToast('Kiểm tra hoàn tất');
      }

      function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const chatBox = document.getElementById('chatBox');
        const message = chatInput.value;
        if (!message) return;
        chatBox.innerHTML += `<p><strong>Bạn:</strong> ${message}</p>`;
        chatBox.innerHTML += `<p><strong>Grok:</strong> Chào bạn! Tôi đang xử lý...</p>`;
        chatInput.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function initTradingView() {
        new TradingView.widget({
          width: '100%',
          height: 300,
          symbol: 'OKX:PIUSDT',
          interval: 'D',
          timezone: 'Etc/UTC',
          theme: 'dark',
          style: '1',
          locale: 'en',
          container_id: 'tradingview_chart',
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        initStarfield();
        loadUserData();
        initTradingView();
        setTimeout(() => {
          const dragon = document.getElementById('dragon');
          dragon.classList.add('show');
          setTimeout(() => dragon.classList.remove('show'), 5000);
        }, 1000);
      });
    </script>
  </body>
</html>
