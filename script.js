const memberData = {
  "001": {
    name: "HOÀNG VĂN MINH ",
    avatar: "https://bom.so/gmB6v2",
    wallet_address:
      "GAB3DTZTDHAQQ2IXO4RDPMYQY3CNZABM6ZGK4HWK55QKRQ6W6QCKRSDQ",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GAB3DTZTDHAQQ2IXO4RDPMYQY3CNZABM6ZGK4HWK55QKRQ6W6QCKRSDQ",
  },
  "002": {
    name: "LÊ VĂN HOẰNG",
    avatar:
      "https://cdn-ilcbnhb.nitrocdn.com/eyWebYtfntWmnihDSZRZvIqipddxdlOp/assets/images/optimized/rev-0a2b4a3/minepi.com/wp-content/uploads/2022/06/b7-1536x864.jpg",
    wallet_address:
      "GCVBQP2M5AWPLHFLUWX7ZRSE24INWWYEYC2EI3NPQWXIL5WVXXZITGJP",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GCVBQP2M5AWPLHFLUWX7ZRSE24INWWYEYC2EI3NPQWXIL5WVXXZITGJP",
  },
  "003": {
    name: "PHẠM THỊ XUÂN",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/333513902_1932195023807300_1163851942859129592_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeEHUbUzai7uybMKKCX41vePUHHOaW9qRuVQcc5pb2pG5TMcLbXM7749XtjmZxexAOiueFtBjmWgkEO3QyI37KQg&_nc_ohc=2welsrt2YlMQ7kNvwFOc7hn&_nc_oc=Adk_sEaoXH3oRXMqnoqfoFZUJeW51zk8C1kGlxqHXsw4ssAxOaotBjRCgMthjIawAkRMVzySEDrzJzpaMu857opF&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=fbVmX5ala3m2lS9mp2CWoA&oh=00_AfHdYB0zfaTS4NOm24PhuUW9b6Un0nwF_rlNw0Uz3HPn-w&oe=6810E999",
    wallet_address:
      "GBDUXC2JUGEVI7N2NGLXB6B3VMUUVNUK6QI4TL5XIB2LIY3U7CDGK3B4",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GBDUXC2JUGEVI7N2NGLXB6B3VMUUVNUK6QI4TL5XIB2LIY3U7CDGK3B4",
  },
  "004": {
    name: "LÊ THỊ HƯƠNG",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/491577955_1189938295959905_8489318223622425228_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEKaNmN3EMNo5OPTJm-RTXghTawRiFc5_WFNrBGIVzn9Ru16jvb4yNoeTmWk3xiLZ9qkucZiptZAKXVCXh6-qhQ&_nc_ohc=XsGUn2tjS18Q7kNvwGmpi4-&_nc_oc=AdmTx9BTl2UKWp94btd4tMJRKnEbS5WceXszgrJ_EZgbxBXUsFgK8IDuYfMrcCQbyrRhC1MBxsVRSGZA852cw4sz&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=9yomIWlBUAh83U6ENEt4Kw&oh=00_AfFb9s9k0xdsMtfF4H9cXikQXb4JxZlHTA7yZQZsz12g6g&oe=6810B70E",
    wallet_address:
      "GCWRIG2I5BNCTN5HXSMAYPQC45MRY7BQFX6AUUPAKTGACFZLBDGJG7I3",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GCWRIG2I5BNCTN5HXSMAYPQC45MRY7BQFX6AUUPAKTGACFZLBDGJG7I3",
  },
  "005": {
    name: "LÊ TRỌNG KHOA",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/493192748_1733657324175687_1257877052875128746_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeH8XsKzNXgL0yj8z53qHIOtaVJWQIRCD6FpUlZAhEIPoWvV_ysyrHvZPL6RcheGuoJ6PVB5QKk-G0NLasDmDZJg&_nc_ohc=7Px-qfQ5lWQQ7kNvwHYVFhk&_nc_oc=AdlpfYi2vi89mFfK7IPldFASnOFj3koz62XDT8UC5Q0xUTR_aY3SwcSCDv5Fup1zqqo_quOvwDEk_C4sHs19Purs&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=exEYcb5mTNsTiCTOXVZr6A&oh=00_AfEs3ZBU6la6YyE0i-PZlOEDbZRw69eU9zOT7VJbJtg3ng&oe=6810F531",
    wallet_address:
      "GDMBS366RAH5STHNFCH3QWLV4VNK2U77TGFU7WEG66ZFGMHGOWZCHDOZ",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GDMBS366RAH5STHNFCH3QWLV4VNK2U77TGFU7WEG66ZFGMHGOWZCHDOZ",
  },
  "006": {
    name: "HOÀNG VĂN TRỤ",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/493108752_1733753667499386_17622212115165894_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeFWkb5oRJIywNLPIbarT4xAsXKWT3Q0IG2xcpZPdDQgbZLWj82Oe1iFMByWKW-T1pN3-jkNFbqcGzuCvZA8kwfw&_nc_ohc=u3JjcYuZ3HUQ7kNvwFpJuhS&_nc_oc=AdnqHLjnrpmTiBtX9uIlyjCnXBRxMsXfixwUT9c2OQBZ65Z53aC8PNtiiKH5fRaiIpOjQLtXWgkDjLJAjvGRde_Uhh&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=PzpxmMuS2kTQyGk6q2qdbA&oh=00_AfHffHzmd2bPGcBrxcl7rtaT_HjpOuDn-SSyVnUYJ2ClXQ&oe=68113600",
    wallet_address:
      "GC4QQVU6A4EWTNCW4235WUOQ5FHKBOF57RKO2EPTIXDJKRYTLXZOHSGN",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GC4QQVU6A4EWTNCW4235WUOQ5FHKBOF57RKO2EPTIXDJKRYTLXZOHSGN",
  },
  "007": {
    name: "MINH TRANG",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/459020914_2207803129648889_9083612727790770567_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeEJB1D7cb229eMaz1Tnljv37WSJkrt-6NXtZImSu37o1VVf19czvRfBbJtbDj5OR34CVLCU34_-69wPg090ODaa&_nc_ohc=lzre0bmBz-AQ7kNvwE7BfJp&_nc_oc=Adm9GKxGty-0Z42FQwYm0_uwI8Nd409RtQMch6rxOMi7eABoW5Mt6sByJdjrKm7jv_u_o5n4wbAmAZfr__fPcBGs&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=N5PB6m8Jb2AphoVgDZwqCQ&oh=00_AfFrra6S7brzwMX_b23hAUnqPa4gQxdUkMUNMJFz49RlsQ&oe=68126FF6",
    wallet_address:
      "GD7M2UZCORSH4AJUJJN2V56MAA33OCIMYMRJ6OXMBQPG5T2FJ4OZ6TA6",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GD7M2UZCORSH4AJUJJN2V56MAA33OCIMYMRJ6OXMBQPG5T2FJ4OZ6TA6",
  },
  "008": {
    name: "LÊ THỊ HÀ",
    avatar:
      "https://scontent.fthd2-4.fna.fbcdn.net/v/t39.30808-6/491397391_122228848976217325_5812334186522958901_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeGkgyQ87OtvNEhgg2G8NL2rwhyzNJKY4HbCHLM0kpjgdghCH501spAOZjH5JdhPl-dGkXQHUToUb8AsZm2_pr4h&_nc_ohc=CDt9Dj35ZmEQ7kNvwHzjhmP&_nc_oc=Adk5SG-e19biNbTLAauHy1rlHbBax96hK7tKu4v4hXaNEbwV_vznFKPrRGztEP1t8zDHFjJVjcBmGK3EGKf22QnV&_nc_zt=23&_nc_ht=scontent.fthd2-4.fna&_nc_gid=g6gl2ukwn3CLEAWEJSh_Hw&oh=00_AfE4YYjuD-c8SpfzVNTIwNnF3Cn-6yPM69g9RRmnTrrp1g&oe=6813C792",
    wallet_address:
      "GAL4V2DVKA437NPZT2B6NEQA7AJ4BE53OCKQUXNJ44G3Z3IJF3BGZ7SS",
    explorer_link:
      "https://blockexplorer.minepi.com/mainnet/accounts/GAL4V2DVKA437NPZT2B6NEQA7AJ4BE53OCKQUXNJ44G3Z3IJF3BGZ7SS",
  },
};

let userData = {
  name: "Tên của bạn",
  walletAddress: "Chưa nhập địa chỉ ví",
  avatar: "https://via.placeholder.com/80",
  balance: 5.0,
  ppBalance: 0,
  pidogeBalance: 0,
  piBalance: 0,
  lastCheckIn: null,
  password: "123456",
};

// Lấy tag_id từ URL và hiển thị thông tin khách hàng
const urlParams = new URLSearchParams(window.location.search);
const tagId = urlParams.get("tag_id");

if (tagId && memberData[tagId]) {
  const member = memberData[tagId];
  userData.name = member.name;
  userData.walletAddress = member.wallet_address;
  userData.avatar = member.avatar;

  document.getElementById("userName").innerText = userData.name;
  document.getElementById("walletAddress").innerText = userData.walletAddress;
  document.getElementById("avatar").src = userData.avatar;
} else {
  document.getElementById("userName").innerText = "Không tìm thấy thông tin";
  document.getElementById("walletAddress").innerText =
    "Không tìm thấy địa chỉ ví";
  document.getElementById("avatar").src = "https://via.placeholder.com/80";
}

// Hiển thị/thiết lập modal chỉnh sửa
function showEditModal() {
  const modal = document.getElementById("editModal");
  modal.classList.remove("hidden");
  document.getElementById("editUserName").value = userData.name;
  document.getElementById("editWalletAddress").value = userData.walletAddress;
  document.getElementById("editAvatarInput").value = "";
}

function hideEditModal() {
  const modal = document.getElementById("editModal");
  modal.classList.add("hidden");
}

// Lưu thay đổi
function saveChanges() {
  const password = document.getElementById("passwordInput").value.trim();
  if (password !== userData.password) {
    showModal("Mật khẩu không đúng!");
    return;
  }

  const editUserName = document.getElementById("editUserName").value.trim();
  const editWalletAddress = document
    .getElementById("editWalletAddress")
    .value.trim();
  const editAvatarInput = document.getElementById("editAvatarInput").files[0];

  if (editUserName) {
    userData.name = editUserName;
    document.getElementById("userName").innerText = userData.name;
  }

  if (editWalletAddress) {
    userData.walletAddress = editWalletAddress;
    document.getElementById("walletAddress").innerText =
      userData.walletAddress;
  }

  if (editAvatarInput) {
    const reader = new FileReader();
    reader.onload = function (e) {
      userData.avatar = e.target.result;
      document.getElementById("avatar").src = userData.avatar;
    };
    reader.readAsDataURL(editAvatarInput);
  }

  hideEditModal();
  showModal("Thông tin đã được cập nhật!");
}

// Kéo thả hình ảnh trong modal
const editDropZone = document.getElementById("editDropZone");
editDropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  editDropZone.classList.add("border-blue-500");
});
editDropZone.addEventListener("dragleave", () => {
  editDropZone.classList.remove("border-blue-500");
});
editDropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  editDropZone.classList.remove("border-blue-500");
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith("image/")) {
    const reader = new FileReader();
    reader.onload = function (event) {
      userData.avatar = event.target.result;
      document.getElementById("avatar").src = userData.avatar;
    };
    reader.readAsDataURL(file);
  } else {
    showModal("Vui lòng chọn một file hình ảnh!");
  }
});

// Sao chép địa chỉ ví
function copyWalletAddress() {
  navigator.clipboard.writeText(userData.walletAddress);
  showModal("Đã sao chép địa chỉ ví!");
}

// Kiểm tra số dư
function checkBalance() {
  showModal(`Số dư hiện tại: ${userData.balance.toFixed(2)} Pi`);
}

// Điểm danh
function checkIn() {
  const today = new Date().toDateString();
  if (userData.lastCheckIn === today) {
    document.getElementById("checkInStatus").classList.remove("hidden");
    showModal("Bạn đã điểm danh hôm nay!");
    return;
  }

  const ppAdded = 5;
  const pidogeAdded = 50;
  userData.ppBalance += ppAdded;
  userData.pidogeBalance += pidogeAdded;
  userData.lastCheckIn = today;

  document.getElementById("ppBalance").innerText = `${userData.ppBalance} PP`;
  document.getElementById(
    "pidogeBalance"
  ).innerText = `${userData.pidogeBalance} Pidoge`;
  document.getElementById("checkInStatus").classList.add("hidden");
  showModal(
    `Điểm danh thành công! Bạn nhận ${ppAdded} PP và ${pidogeAdded} Pidoge.`
  );
}

// Đổi PP ra Pi
function convertPPtoPi() {
  if (userData.ppBalance < 100) {
    showModal("Cần ít nhất 100 PP để đổi thành 1 Pi!");
    return;
  }

  const piAmount = Math.floor(userData.ppBalance / 100);
  userData.piBalance += piAmount;
  userData.ppBalance -= piAmount * 100;

  document.getElementById("ppBalance").innerText = `${userData.ppBalance} PP`;
  document.getElementById("piBalance").innerText = `${userData.piBalance.toFixed(
    2
  )} Pi`;
  showModal(`Đổi thành công! Bạn nhận ${piAmount} Pi.`);
}

// Rút Pi
function withdrawPi() {
  const piValueUSD = 1.0;
  const minWithdrawUSD = 1.0;
  const minWithdrawPi = minWithdrawUSD / piValueUSD;

  if (userData.piBalance < minWithdrawPi) {
    showModal(
      `Số dư không đủ! Cần tối thiểu ${minWithdrawPi.toFixed(2)} Pi (~1 USD).`
    );
    return;
  }

  const amountPi = userData.piBalance;
  userData.piBalance = 0;
  document.getElementById("piBalance").innerText = `${userData.piBalance.toFixed(
    2
  )} Pi`;
  document.getElementById(
    "withdrawStatus"
  ).innerText = `Yêu cầu rút ${amountPi.toFixed(2)} Pi (~${(
    amountPi * piValueUSD
  ).toFixed(2)} USD). Vui lòng chờ xử lý thủ công.`;
  showModal(
    `Yêu cầu rút ${amountPi.toFixed(
      2
    )} Pi đã được gửi. Tôi sẽ chuyển thủ công về địa chỉ ví: ${
      userData.walletAddress
    }.`
  );
}

// Kiểm tra an toàn web/ứng dụng
async function checkSafety() {
  const url = document.getElementById("safetyUrl").value.trim();
  const type = document.getElementById("checkType").value;
  const checkButton = document.getElementById("checkButton");
  const loadingSpinner = document.getElementById("loadingSpinner");
  const resultDiv = document.getElementById("safetyResult");

  // Validate URL
  const urlRegex = /^(https?:\/\/|market:\/\/|itms-apps:\/\/)?([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?$/i;
  if (!url || !urlRegex.test(url)) {
    showModal(
      "Vui lòng nhập URL hợp lệ (ví dụ: https://example.com, market://details?id=com.example, hoặc itms-apps://...)"
    );
    return;
  }

  // Check cache
  const cacheKey = `${type}:${url}`;
  const cachedResult = localStorage.getItem(cacheKey);
  if (cachedResult) {
    const safetyData = JSON.parse(cachedResult);
    displaySafetyResult(safetyData);
    return;
  }

  // Show loading state
  checkButton.disabled = true;
  loadingSpinner.style.display = "block";
  resultDiv.classList.add("hidden");

  try {
    let safetyData;
    if (type === "website") {
      safetyData = await checkWebsiteSafety(url);
    } else {
      safetyData = await checkAppSafety(url);
    }

    // Cache result
    localStorage.setItem(cacheKey, JSON.stringify(safetyData));

    // Display result
    displaySafetyResult(safetyData);
  } catch (error) {
    showModal(`Lỗi khi kiểm tra: ${error.message}. Vui lòng thử lại.`);
    checkButton.disabled = false;
    loadingSpinner.style.display = "none";
  }
}

// Kiểm tra an toàn website với Google Safe Browsing
async function checkWebsiteSafety(url) {
  const apiKey = "AIzaSyCvmam6XFzrdYLd-9Dkd5v0y-VnLG6KYKw";
  const safeBrowsingUrl = `https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${apiKey}`;
  const payload = {
    client: {
      clientId: "pi-wallet",
      clientVersion: "1.0.0",
    },
    threatInfo: {
      threatTypes: [
        "MALWARE",
        "SOCIAL_ENGINEERING",
        "UNWANTED_SOFTWARE",
        "POTENTIALLY_HARMFUL_APPLICATION",
      ],
      platformTypes: ["ANY_PLATFORM"],
      threatEntryTypes: ["URL"],
      threatEntries: [{ url }],
    },
  };

  const response = await fetch(safeBrowsingUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!response.ok) {
    throw new Error("Không thể kết nối tới Google Safe Browsing API");
  }

  const data = await response.json();
  let score = 90;
  let warnings = [];
  let status = "An toàn";
  let color = "green";

  if (data.matches) {
    score = 20;
    status = "Nguy hiểm";
    color = "red";
    warnings = data.matches.map((match) => {
      switch (match.threatType) {
        case "MALWARE":
          return "Website chứa mã độc";
        case "SOCIAL_ENGINEERING":
          return "Nguy cơ lừa đảo (phishing)";
        case "UNWANTED_SOFTWARE":
          return "Phần mềm không mong muốn";
        case "POTENTIALLY_HARMFUL_APPLICATION":
          return "Ứng dụng tiềm ẩn nguy hiểm";
        default:
          return "Rủi ro không xác định";
      }
    });
  } else if (!url.startsWith("https://")) {
    score = 60;
    status = "Cảnh báo";
    color = "yellow";
    warnings.push("Website không sử dụng HTTPS");
  }

  return { score, status, color, warnings };
}

// Kiểm tra an toàn ứng dụng
async function checkAppSafety(url) {
  const normalizedUrl = url.toLowerCase();
  const safeAppDomains = [
    "play.google.com",
    "itunes.apple.com",
    "apps.apple.com",
  ];
  let score = 80;
  let warnings = [];
  let status = "An toàn";
  let color = "green";

  // Validate app store URL
  const isSafeDomain = safeAppDomains.some((domain) =>
    normalizedUrl.includes(domain)
  );
  if (!isSafeDomain && !normalizedUrl.startsWith("market://") && !normalizedUrl.startsWith("itms-apps://")) {
    score = 40;
    status = "Nguy hiểm";
    color = "red";
    warnings.push("Ứng dụng không từ cửa hàng chính thức");
  } else if (normalizedUrl.includes("apk")) {
    score = 50;
    status = "Cảnh báo";
    color = "yellow";
    warnings.push("Nguồn tải có thể không an toàn (.apk)");
  }

  // Check URL with Safe Browsing for phishing risks
  const safeBrowsingResult = await checkWebsiteSafety(url);
  if (safeBrowsingResult.status !== "An toàn") {
    score = Math.min(score, safeBrowsingResult.score);
    status = safeBrowsingResult.status;
    color = safeBrowsingResult.color;
    warnings = [...warnings, ...safeBrowsingResult.warnings];
  }

  return { score, status, color, warnings };
}

// Hiển thị kết quả kiểm tra
function displaySafetyResult(safetyData) {
  const resultDiv = document.getElementById("safetyResult");
  const checkButton = document.getElementById("checkButton");
  const loadingSpinner = document.getElementById("loadingSpinner");

  resultDiv.classList.remove("hidden");
  document.getElementById("safetyStatus").innerText = safetyData.status;
  document.getElementById(
    "safetyStatus"
  ).className = `ml-2 text-${safetyData.color}-600`;
  document.getElementById("safetyScore").innerText = safetyData.score;
  document.getElementById("safetyWarnings").innerText = safetyData.warnings
    .length
    ? safetyData.warnings.join("; ")
    : "Không có cảnh báo";

  // Update status icon
  const statusIcon = document.getElementById("statusIcon");
  statusIcon.className = `w-5 h-5 ml-2 text-${safetyData.color}-600`;
  statusIcon.innerHTML =
    safetyData.status === "An toàn"
      ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
      : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';

  // Reset loading state
  checkButton.disabled = false;
  loadingSpinner.style.display = "none";
}

// Xóa form
function clearForm() {
  document.getElementById("safetyUrl").value = "";
  document.getElementById("checkType").value = "website";
  document.getElementById("safetyResult").classList.add("hidden");
}

// Hiển thị modal thông báo
function showModal(message) {
  const modal = document.createElement("div");
  modal.className =
    "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal";
  modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm">
                    <p class="text-gray-800 mb-4">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">OK</button>
                </div>
            `;
  document.body.appendChild(modal);
}

// Khởi tạo TradingView Widget
window.onload = function () {
  new TradingView.widget({
    container_id: "tradingview_chart",
    width: "100%",
    height: 450,
    symbol: "OKX:PIUSDT",
    interval: "D",
    timezone: "Etc/UTC",
    theme: "dark",
    style: "1",
    locale: "en",
    toolbar_bg: "#1e222d",
    enable_publishing: false,
    allow_symbol_change: true,
    details: true,
    hotlist: true,
    calendar: true,
    studies: ["Volume@tv-basicstudies", "RSI@tv-basicstudies"],
    show_popup_button: true,
    popup_width: "1000",
    popup_height: "650",
    grid: {
      color: "#444",
    },
  });
};
